<html>
<head>

<title>42 Editor</title>

<style type="text/css" media="screen">
#editor {
    width: 100%;
    height: 300px;
    border: 1px solid lightgray;
}

#preview {
    width: 100%;
    height: 300px;
    border: 1px solid lightgray;
    display: none;
}

#editor-preview-container {
    display: flex;
}

#output {
    width: 100%;
    height: 300px;
    border: 1px solid lightgray;
}

#duration-paragraph {
    margin-left: 1em;
}

#links {
    float: right;
    padding: 1em;
}

body {
    font-family: system, -apple-system, ".SFNSText-Regular", "San Francisco", "Roboto", "Segoe UI", "Helvetica Neue", "Lucida Grande", sans-serif;
}
</style>

<script src="libs/ace.js" charset="utf-8"></script>
<script src="libs/jszip.min.js" charset="utf-8"></script>
<script src="libs/mode-l42.js"></script>
<script src="libs/theme-l42_eclipse.js"></script>
<script src="urls.js"></script>

</head>
<body>

<div id="links">
    <h3>Links:</h3>
    <ul>
        <li><a href="https://l42.is">42 - Metaprogramming as default</a></li>
        <li><a href="https://l42.is/tutorial_01Basics.xhtml">42 Tutorial</a></li>
    </ul>
</div>

<h1>42 Editor</h1>

<p>
    <label for="sample-program-select" title="Choose which sample program you would like to run from this list">Load sample program:</label>
    <select id="sample-program-select" title="Choose which sample program you would like to run from this list">
        <option selected>Hello World</option>
        <option>Point</option>
        <option>Simple Invariant</option>
        <option>Hello World challenge</option>
    </select>
    <input type="button" onclick="loadSampleProgram()" value="Load Sample" title="Load the selected sample program into the editor">
</p>

<p>
    <label for="open-file-picker" title="Open .L42 files, or .zip files">Open File:</label>
    <input type="file" id="open-file-picker" multiple title="Choose one or more files to load into the editor. They can be .L42 files or ZIP files.">
    <input type="button" value="Load File" title="Load the selected file(s) into the editor" onclick="loadFileHandler()">
</p>

<ul id="file-tree">
    <li>This.L42</li>
</ul>
<div id="editor-preview-container">
    <div id="editor"></div>
    <div id="preview"></div>
</div>

<p>
    <input type="button" id="execute" value="Run" onclick="execute()" title="Execute the program on the 42 server in the cloud">
    <input type="button" value="Download as ZIP" onclick="downloadAsZip()" title="Click here to save your program as a ZIP file to your computer">
    <span id="duration-paragraph">
        <label for="duration">Duration: </label>
        <span id="duration">1.234 seconds</span>
    </span>
</p>

<div id="output"></div>

<script>

// add '?server=https://example.com' this page's URL to override the server URL

const GUI = {
    currentProgram: null,
    currentFileName: null,

    isTemplate: () => {
        if (GUI.currentProgram["template"]) {
            return true;
        }
        return false;
    },

    loadProgram: (program) => {
        GUI.currentProgram = JSON.parse(JSON.stringify(program));
        if (typeof GUI.currentProgram == "string") {
            GUI.currentProgram = {
                "This.L42": GUI.currentProgram,
            }
        }
        let fileTreeHtml = '';
        let initialFilename = GUI.currentProgram["This.L42"] ? "This.L42" : null;
        for (let filename in GUI.currentProgram) {
            if (filename == "template")
                continue;
            if (initialFilename == null) {
                initialFilename = filename;
            }
            fileTreeHtml += `<li><a href="javascript:GUI.switchToFile('${filename}')">${filename}</a></li>`;
        }
        document.getElementById('file-tree').innerHTML = fileTreeHtml;
        if (initialFilename == null) {
            alert("Error: the selected 42 project does not contain any files!");
            GUI.currentProgram = { "This.L42": "" };
            initialFilename = "This.L42";
        }

        GUI.currentFileName = initialFilename;
        
        if (GUI.isTemplate()) {
            document.getElementById('preview').style.display = 'block';
            window.preview.setValue(GUI.currentProgram[GUI.currentFileName], -1);
            window.editor.setValue('', -1);
        } else {
            document.getElementById('preview').style.display = 'none';
            window.editor.setValue(GUI.currentProgram[GUI.currentFileName], -1);
        }
    },

    switchToFile: (filename) => {
        GUI.currentProgram[GUI.currentFileName] = editor.getValue();
        GUI.currentFileName = filename;
        window.editor.setValue(GUI.currentProgram[GUI.currentFileName], -1);
    },

    getProgram: () => {
        GUI.currentProgram[GUI.currentFileName] = editor.getValue();
        return GUI.currentProgram;
    },

    getRenderedProgram: () => {
        if (!GUI.isTemplate()) {
            return GUI.getProgram();
        }
        let template = GUI.currentProgram[GUI.currentFileName];
        let editorCode = window.editor.getValue()
        let previewCode = template;
        if (editorCode.length > 0) {
            previewCode = template.replaceAll('???', editorCode);
        }
        let result = {};
        result[GUI.currentFileName] = previewCode;
        return result;
    },

    // called on every keypress to update preview editor view
    updateTemplate: () => {
        let rendered = GUI.getRenderedProgram();
        window.preview.setValue(rendered[GUI.currentFileName], -1);
    },
};

window.onload = function() {
    const editor = ace.edit('editor', { minLines: 10, maxLines: 50 });
    editor.session.setMode('ace/mode/l42');
    window.editor = editor;
    editor.getSession().on('change', e => {
        if (GUI.isTemplate()) {
            GUI.updateTemplate();
        }
    });

    const preview = ace.edit('preview', { minLines: 10, maxLines: 50 });
    preview.session.setMode('ace/mode/l42');
    preview.setReadOnly(true);
    window.preview = preview;

    const output = ace.edit('output', { minLines: 5, maxLines: 20 });
    output.session.setMode('ace/mode/text');
    output.setReadOnly(true);
    window.output = output;
    clearOutput();

    loadSampleProgram();
}

async function loadFile(program, name, fileContent) {
    if (name.toLowerCase().endsWith('.l42')) {
        let fileString = null;
        if ('text' in fileContent) {
            fileString = await fileContent.text();
        } else if ('async' in fileContent) {
            fileString = await fileContent.async('text');
        }
        program[name] = fileString;
    } else if (name.toLowerCase().endsWith('.zip')) {
        // handle zip files
        let zip = await JSZip.loadAsync(fileContent);

        // check for a single top-level folder
        let topLevelFolder = null;
        zip.forEach((path, file) => {
            if (!path.includes('/')) {
                topLevelFolder = '';
            }
            if (topLevelFolder == null) {
                topLevelFolder = path.split('/')[0];
            } else {
                if (topLevelFolder != path.split('/')[0]) {
                    topLevelFolder = '';
                }
            }
        });
        let fileList = [];
        zip.forEach((path, file) => {
            if (file.dir) return;
            let relPath = path.substring(topLevelFolder.length);
            if (relPath.startsWith('/')) {
                relPath = relPath.substring(1);
            }
            if (relPath == "Setti.ngs") return;
            fileList.push({
                name: relPath,
                file: file,
            });
        });
        for (let file of fileList) {
            loadFile(program, file.name, file.file);
            let fileContent = await file.file.async('text');
            program[file.name] = fileContent;
        }
    } else if (name.toLowerCase().endsWith('setti.ngs')) {
        return;
    } else {
        console.log('Ignoring unsupported file type ' + name);
    }
}

async function loadFileHandler() {
    const files = document.getElementById('open-file-picker').files;
    if (files.length == 0) {
        alert('No file selected');
        return;
    }
    let program = {};
    for (let file of files) {
        await loadFile(program, file.name, file);
    }
    GUI.loadProgram(program);
}

async function downloadAsZip() {
    let zip = new JSZip();
    let program = GUI.getProgram();
    for (let filename in program) {
        zip.file(filename, program[filename]);
    }
    let base64 = await zip.generateAsync({ type: 'base64' });
    let filename = `${new Date().toLocaleString()}.zip`;
    location.href = 'data:application/zip;base64,' + base64;
}

function loadSampleProgram() {
    const elem = document.getElementById('sample-program-select');
    const sampleProgram = elem.options[elem.selectedIndex].text;
    let code = '';
    switch (sampleProgram) {
        case 'Hello World':
        default:
            code = HELLO_WORLD;
            break;
        case 'Point':
            code = POINT;
            break;
        case 'Simple Invariant':
            code = SIMPLE_INVARIANT;
            break;
        case 'Hello World challenge':
            code = PRINT_HELLO_WORLD_CHALLENGE;
            break;
    }
    GUI.loadProgram(code);
}

// modified from https://stackoverflow.com/a/5448595
function findGetParameter(parameterName) {
    let result = null;
    location.search.substr(1).split("&").forEach(item => {
        let tmp = item.split("=");
        if (tmp[0] === parameterName) {
            result = decodeURIComponent(tmp[1]);
        }
    });
    return result;
}

function modifyUrl(url) {
    // consider http:, https:, file: etc.
    if (!url.includes(':')) {
        url = 'https://' + url;
    }
    if (!url.includes('/execute')) {
        if (!url.endsWith('/')) {
            url += '/';
        }
        url += 'execute';
    }
    return url;
}

async function multiFetch(options) {
    const overrideUrl = findGetParameter('server');
    if (overrideUrl) {
        console.log(`Using override URL '${overrideUrl}'...`);
        return await fetch(modifyUrl(overrideUrl), options);
    }

    // try fetching each of the possible server URLs in order
    for (const url of window.L42_SERVER_URLS) {
        try {
            const modifiedUrl = modifyUrl(url);
            console.log(`Using url '${modifiedUrl}'...`);
            return await fetch(modifiedUrl, options);
        } catch (e) {
            console.log(e);
        }
    }
    return null;
}

function showResultOutput(result) {
    if (!result.ok) {
        return "Error: " + result.message;
    }
    let resultString = '';
    if (result.stderr && !result.stdout) {
        resultString = result.stderr;
    } else if (result.stdout && !result.stderr) {
        resultString = result.stdout;
    } else if (result.stdout && result.stderr) {
        resultString = `stdout:\n${result.stdout}\nstderr:\n${result.stderr}`;
    }
    // -1 to clear selection and move cursor to start of line
    window.output.setValue(resultString, -1);

    document.getElementById('duration-paragraph').style.display = 'inline';
    document.getElementById('duration').innerHTML = result.duration + ' seconds';
    if (result.returncode == 0) {
        document.getElementById('output').style.color = 'black';
    } else {
        document.getElementById('output').style.color = 'red';
    }
}

function clearOutput() {
    window.output.setValue('');
    document.getElementById('duration-paragraph').style.display = 'none';
}

async function execute() {
    const executeButton = document.getElementById('execute');
    try {
        const editor = window.editor;
        executeButton.disabled = true;
        executeButton.value = 'Please wait...';
        clearOutput();
        let program = JSON.parse(JSON.stringify(GUI.getRenderedProgram()));
        if (program["template"]) {
            delete program["template"];
        }
        const result = await multiFetch({
            method: 'POST',
            body: JSON.stringify({
                files: program,
            }),
        });
        if (!result) {
            alert('Unable to contact server, see log for details');
        }
        const jsonResult = await result.json();
        showResultOutput(jsonResult);
    } catch (e) {
        window.output.setValue(e.toString(), -1);
    } finally {
        executeButton.disabled = false;
        executeButton.value = "Run";
    }
}

const HELLO_WORLD = `reuse [L42.is/AdamsTowel]
Main=(
  Debug(S"Hello world from 42")
  )`;

const PRINT_HELLO_WORLD_CHALLENGE = {
    "This.L42": `reuse [L42.is/AdamsTowel]
Main=(
  Debug(S"???")
  )`,
    template: true,
};

const POINT = {
    "This.L42": `reuse [L42.is/AdamsTowel]
Point = Data:{...}

Main=(
  Debug(S"Hello world from 42!")

  imm Point p = (Point(x=5\\, y=2\\).sum(Point(x=3\\, y=1\\)))
  Debug(S"p = %p")
  )\n`,
  "Point.L42": `Num x
Num y
method
Point add(Num x) = //long version
  Point(x=x+this.x(), y=this.y())
method
Point add(Num y) = //shorter
  this.with(y=y+this.y())
method
Point sum(Point that) =
  Point(x=this.x()+that.x(), y=this.y()+that.y())\n`
};

const SIMPLE_INVARIANT = `reuse [L42.is/AdamsTowel]
Point = Data:{
  Double x
  Double y
  @Cache.Now class method Double distanceFromOrigin(Double x, Double y) = 
    ((x*x)+(y*y)).pow(exp=\\"0.5")
  // x and y must always be positive
  @Cache.Now class method Void invariant(Double x, Double y) = 
    if !(x>=0Double && y>=0Double) error X"""%
      | Invalid state:
      | x = %x
      | y = %y
      """
  }

Main=(
  Point p = Point(x=Double"5", y=Double"3")
  // This would result in an error:
  //Point p2 = Point(x=Double"5", y=Double"-3")
  Debug(S"p = %p")
  )
`;

</script>

</body>
</html>
