<html>
<head>

<title>42 Editor</title>

<style type="text/css" media="screen">
#editor {
    width: 100%;
    height: 300px;
    border: 1px solid lightgray;
}

#output {
    width: 100%;
    height: 300px;
    border: 1px solid lightgray;
}
body {
    font-family: system, -apple-system, ".SFNSText-Regular", "San Francisco", "Roboto", "Segoe UI", "Helvetica Neue", "Lucida Grande", sans-serif;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.9.1/jszip.min.js" charset="utf-8"></script>
<script src="https://l42.is/js/mode-l42.js"></script>
<script src="https://l42.is/js/theme-l42_eclipse.js"></script>
<script src="urls.js"></script>

</head>
<body>

<h1>42 Editor</h1>

<p>
    <label for="sample-program-select">Load sample program:</label>
    <select id="sample-program-select">
        <option selected>Hello World</option>
        <option>Point</option>
        <option>Simple Invariant</option>
    </select>
    <input type="button" onclick="loadSampleProgram()" value="Load">
</p>

<p>
    <label for="open-file-picker">Open File:</label>
    <input type="file" id="open-file-picker" multiple>
    <input type="button" value="Load File" onclick="loadFile()">
</p>

<ul id="file-tree">
    <li>This.L42</li>
</ul>
<div id="editor"></div>

<p>
    <input type="button" id="execute" value="Run" onclick="execute()">
</p>

<div id="output"></div>

<h3>Links:</h3>
<ul>
    <li><a href="https://l42.is">42 - Metaprogramming as default</a></li>
    <li><a href="https://l42.is/tutorial_01Basics.xhtml">42 Tutorial</a></li>
</ul>

<script>

// add '?server=https://example.com' this page's URL to override the server URL

const GUI = {
    currentProgram: null,
    currentFile: null,

    loadProgram: (program) => {
        GUI.currentProgram = JSON.parse(JSON.stringify(program));
        if (typeof GUI.currentProgram == "string") {
            GUI.currentProgram = {
                "This.L42": GUI.currentProgram,
            }
        }
        let fileTreeHtml = '';
        let initialFilename = GUI.currentProgram["This.L42"] ? "This.L42" : null;
        for (let filename in GUI.currentProgram) {
            if (initialFilename == null) {
                initialFilename = filename;
            }
            fileTreeHtml += `<li><a href="javascript:GUI.openFile('${filename}')">${filename}</a></li>`;
        }
        document.getElementById('file-tree').innerHTML = fileTreeHtml;
        if (initialFilename != null) {
            GUI.currentFile = initialFilename;
            window.editor.setValue(GUI.currentProgram[GUI.currentFile], -1);
        } else {
            alert("The L42 project does not contain any files");
        }
    },

    openFile: (filename) => {
        GUI.currentProgram[GUI.currentFile] = editor.getValue();
        GUI.currentFile = filename;
        window.editor.setValue(GUI.currentProgram[GUI.currentFile], -1);
    },

    getProgram: () => {
        GUI.currentProgram[GUI.currentFile] = editor.getValue();
        return GUI.currentProgram;
    }
};

window.onload = function() {
    const editor = ace.edit('editor', { minLines: 10, maxLines: 50 });
    editor.session.setMode('ace/mode/l42');
    window.editor = editor;

    const output = ace.edit('output', { minLines: 5, maxLines: 20 });
    output.session.setMode('ace/mode/text');
    output.setReadOnly(true);
    window.output = output;

    loadSampleProgram();
}

async function loadFile() {
    const files = document.getElementById('open-file-picker').files;
    if (files.length == 0) {
        alert('No file selected');
        return;
    }
    let program = {};
    if (files.length == 1) {
        let file = files[0];
        if (file.name.endsWith('.zip')) {
            let zip = await JSZip.loadAsync(files[0]);
            console.log(zip);

            // check for a single top-level folder
            let topLevelFolder = null;
            zip.forEach((path, file) => {
                if (topLevelFolder == null) {
                    topLevelFolder = path.split('/')[0];
                } else {
                    if (topLevelFolder != path.split('/')[0]) {
                        topLevelFolder = '';
                    }
                }
            });
            let fileList = [];
            zip.forEach((path, file) => {
                if (file.dir) return;
                let relPath = path.substring(topLevelFolder.length);
                if (relPath.startsWith('/')) {
                    relPath = relPath.substring(1);
                }
                if (relPath == "Setti.ngs") return;
                fileList.push({
                    name: relPath,
                    file: file,
                });
            });
            for (let file of fileList) {
                let fileContent = await file.file.async('text');
                program[file.name] = fileContent;
            }
        } else if (file.name.endsWith('.L42') || file.name.endsWith('.l42')) {
            program["This.L42"] = await files[0].text();
        }
    } else {
        for (let file of files) {
            if (file.name == "Setti.ngs") continue;
            program[file.name] = await file.text();
        }
    }
    GUI.loadProgram(program);
}

function loadSampleProgram() {
    const elem = document.getElementById('sample-program-select');
    const sampleProgram = elem.options[elem.selectedIndex].text;
    let code = '';
    switch (sampleProgram) {
        case 'Hello World':
        default:
            code = HELLO_WORLD;
            break;
        case 'Point':
            code = POINT;
            break;
        case 'Simple Invariant':
            code = SIMPLE_INVARIANT;
            break;
    }
    GUI.loadProgram(code);
}

// modified from https://stackoverflow.com/a/5448595
function findGetParameter(parameterName) {
    let result = null;
    location.search.substr(1).split("&").forEach(item => {
        let tmp = item.split("=");
        if (tmp[0] === parameterName) {
            result = decodeURIComponent(tmp[1]);
        }
    });
    return result;
}

function modifyUrl(url) {
    // consider http:, https:, file: etc.
    if (!url.includes(':')) {
        url = 'https://' + url;
    }
    if (!url.includes('/execute')) {
        if (!url.endsWith('/')) {
            url += '/';
        }
        url += 'execute';
    }
    return url;
}

async function multiFetch(options) {
    const overrideUrl = findGetParameter('server');
    if (overrideUrl) {
        console.log(`Using override URL '${overrideUrl}'...`);
        return await fetch(modifyUrl(overrideUrl), options);
    }

    // try fetching each of the possible server URLs in order
    for (const url of window.L42_SERVER_URLS) {
        try {
            const modifiedUrl = modifyUrl(url);
            console.log(`Using url '${modifiedUrl}'...`);
            return await fetch(modifiedUrl, options);
        } catch (e) {
            console.log(e);
        }
    }
    return null;
}

function buildResultString(result) {
    if (!result.ok) {
        return "Error: " + result.message;
    }
    let str = 'stdout:\n' + result.stdout;
    if (result.stderr) {
        str += '\nstderr:\n' + result.stderr;
    }
    str += '\nreturn code: ' + result.returncode;
    str += '\nduration: ' + result.duration + ' seconds';
    return str;
}

async function execute() {
    const executeButton = document.getElementById('execute');
    try {
        const editor = window.editor;
        executeButton.disabled = true;
        executeButton.value = 'Please wait...';
        window.output.setValue('');
        const result = await multiFetch({
            method: 'POST',
            body: JSON.stringify({
                files: GUI.getProgram(),
            }),
        });
        if (!result) {
            alert('Unable to contact server, see log for details');
        }
        const jsonResult = await result.json();
        const resultString = buildResultString(jsonResult);
        // -1 to clear selection and move cursor to start of line
        window.output.setValue(resultString, -1);
    } catch (e) {
        window.output.setValue(e.toString(), -1);
    } finally {
        executeButton.disabled = false;
        executeButton.value = "Run";
    }
}

const HELLO_WORLD = `reuse [L42.is/AdamsTowel]
Main=(
  Debug(S"Hello world from 42")
  )`;

const POINT = {
    "This.L42": `reuse [L42.is/AdamsTowel]
Point = Data:{...}

Main=(
  Debug(S"Hello world from 42!")

  imm Point p = (Point(x=5\\, y=2\\).sum(Point(x=3\\, y=1\\)))
  Debug(S"p = %p")
  )\n`,
  "Point.L42": `Num x
Num y
method
Point add(Num x) = //long version
  Point(x=x+this.x(), y=this.y())
method
Point add(Num y) = //shorter
  this.with(y=y+this.y())
method
Point sum(Point that) =
  Point(x=this.x()+that.x(), y=this.y()+that.y())\n`
};

const SIMPLE_INVARIANT = `reuse [L42.is/AdamsTowel]
Point = Data:{
  Double x
  Double y
  @Cache.Now class method Double distanceFromOrigin(Double x, Double y) = 
    ((x*x)+(y*y)).pow(exp=\\"0.5")
  // x and y must always be positive
  @Cache.Now class method Void invariant(Double x, Double y) = 
    if !(x>=0Double && y>=0Double) error X"""%
      | Invalid state:
      | x = %x
      | y = %y
      """
  }

Main=(
  Point p = Point(x=Double"5", y=Double"3")
  // This would result in an error:
  //Point p2 = Point(x=Double"5", y=Double"-3")
  Debug(S"p = %p")
  )
`;

</script>

</body>
</html>
