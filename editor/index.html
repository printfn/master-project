<html>
<head>

<title>42 Editor</title>

<style type="text/css" media="screen">
#editor {
    width: 100%;
    height: 300px;
    border: 1px solid lightgray;
}

#output {
    width: 100%;
    height: 300px;
    border: 1px solid lightgray;
}
body {
    font-family: system, -apple-system, ".SFNSText-Regular", "San Francisco", "Roboto", "Segoe UI", "Helvetica Neue", "Lucida Grande", sans-serif;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="https://l42.is/js/mode-l42.js"></script>
<script src="https://l42.is/js/theme-l42_eclipse.js"></script>
<script src="urls.js"></script>

</head>
<body>

<h1>42 Editor</h1>

<p>
<label for="sample-program-select">Load sample program:</label>
<select id="sample-program-select">
    <option selected>Hello World</option>
    <option>Point</option>
    <option>Simple Invariant</option>
</select>
<input type="button" onclick="loadSampleProgram()" value="Load">
</p>

<div id="editor"></div>

<p>
    <input type="button" id="execute" value="Run" onclick="execute()">
</p>

<div id="output"></div>

<script>

// add '?server=https://example.com' this page's URL to override the server URL

const HELLO_WORLD = `reuse [L42.is/AdamsTowel]
Main=(
  Debug(S"Hello world from 42")
  )`;

const POINT = `reuse [L42.is/AdamsTowel]
Point = Data:{
  Num x
  Num y
  method
  Point add(Num x) = //long version
    Point(x=x+this.x(), y=this.y())
  method
  Point add(Num y) = //shorter
    this.with(y=y+this.y())
  method
  Point sum(Point that) =
    Point(x=this.x()+that.x(), y=this.y()+that.y())
  }

Main=(
  Debug(S"Hello world from 42!")

  imm Point p = (Point(x=5\\, y=2\\).sum(Point(x=3\\, y=1\\)))
  Debug(S"p = %p")
  )
`;

const SIMPLE_INVARIANT = `reuse [L42.is/AdamsTowel]
Point = Data:{
  Double x
  Double y
  @Cache.Now class method Double distanceFromOrigin(Double x, Double y) = 
    ((x*x)+(y*y)).pow(exp=\\"0.5")
  // x and y must always be positive
  @Cache.Now class method Void invariant(Double x, Double y) = 
    if !(x>=0Double && y>=0Double) error X"""%
      | Invalid state:
      | x = %x
      | y = %y
      """
  }

Main=(
  Point p = Point(x=Double"5", y=Double"3")
  // This would result in an error:
  //Point p2 = Point(x=Double"5", y=Double"-3")
  Debug(S"p = %p")
  )
`;

window.onload = () => {
    const editor = ace.edit('editor', { minLines: 10, maxLines: 50 });
    editor.session.setMode('ace/mode/l42');
    window.editor = editor;

    const output = ace.edit('output', { minLines: 5, maxLines: 20 });
    output.session.setMode('ace/mode/text');
    output.setReadOnly(true);
    window.output = output;

    loadSampleProgram();
}

function loadSampleProgram() {
    const elem = document.getElementById('sample-program-select');
    const sampleProgram = elem.options[elem.selectedIndex].text;
    let code = '';
    switch (sampleProgram) {
        case 'Hello World':
        default:
            code = HELLO_WORLD;
            break;
        case 'Point':
            code = POINT;
            break;
        case 'Simple Invariant':
            code = SIMPLE_INVARIANT;
            break;
    }
    window.editor.setValue(code);
    window.editor.gotoLine(0); // clear selection
}

// modified from https://stackoverflow.com/a/5448595
function findGetParameter(parameterName) {
    let result = null;
    location.search.substr(1).split("&").forEach(item => {
        let tmp = item.split("=");
        if (tmp[0] === parameterName) {
            result = decodeURIComponent(tmp[1]);
        }
    });
    return result;
}

function modifyUrl(url) {
    // consider http:, https:, file: etc.
    if (!url.includes(':')) {
        url = 'https://' + url;
    }
    if (!url.includes('/execute')) {
        if (!url.endsWith('/')) {
            url += '/';
        }
        url += 'execute';
    }
    return url;
}

async function multiFetch(options) {
    const overrideUrl = findGetParameter('server');
    if (overrideUrl) {
        console.log(`Using override URL '${overrideUrl}'...`);
        return await fetch(modifyUrl(overrideUrl), options);
    }

    // try fetching each of the possible server URLs in order
    for (const url of window.L42_SERVER_URLS) {
        try {
            const modifiedUrl = modifyUrl(url);
            console.log(`Using url '${modifiedUrl}'...`);
            return await fetch(modifiedUrl, options);
        } catch (e) {
            console.log(e);
        }
    }
    return null;
}

function buildResultString(result) {
    if (!result.ok) {
        return "Error: " + result.message;
    }
    let str = 'stdout:\n' + result.stdout;
    if (result.stderr) {
        str += '\nstderr:\n' + result.stderr;
    }
    str += '\nreturn code: ' + result.returncode;
    str += '\nduration: ' + result.duration + ' seconds';
    return str;
}

async function execute() {
    const executeButton = document.getElementById('execute');
    try {
        const editor = window.editor;
        executeButton.disabled = true;
        executeButton.value = 'Please wait...';
        window.output.setValue('');
        const result = await multiFetch({
            method: 'POST',
            body: JSON.stringify({
                files: {
                    "This.L42": editor.getValue(),
                },
            }),
        });
        if (!result) {
            alert('Unable to contact server, see log for details');
        }
        const jsonResult = await result.json();
        const resultString = buildResultString(jsonResult);
        window.output.setValue(resultString);
        window.output.gotoLine(0); // clear selection
    } catch (e) {
        window.output.setValue(e.toString());
        window.output.gotoLine(0);
    } finally {
        executeButton.disabled = false;
        executeButton.value = "Run";
    }
}

</script>

</body>
</html>
